<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trading Bot Status</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; }
    header { padding: 16px 24px; background: #0f172a; color: #e2e8f0; }
    main { padding: 24px; max-width: 900px; margin: 0 auto; }
    .card { border: 1px solid #334155; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .metric { background: #0b1220; border: 1px solid #1f2937; border-radius: 10px; padding: 12px; }
    .metric h3 { margin: 0 0 6px 0; font-size: 13px; color: #94a3b8; font-weight: 600; }
    .metric .value { font-size: 22px; font-weight: 700; }
    .green { color: #10b981; }
    .red { color: #ef4444; }
    table.crypto { width: 100%; border-collapse: collapse; font-size: 13px; }
    table.crypto th, table.crypto td { padding: 6px 8px; border-bottom: 1px solid #1f2937; }
    table.crypto th { text-align: left; color: #94a3b8; font-weight: 600; }
    table.crypto th.num { text-align: right; }
    table.crypto td.num { text-align: right; font-variant-numeric: tabular-nums; }
    footer { text-align: center; color: #94a3b8; padding: 12px; font-size: 12px; }
    a { color: #60a5fa; }
  </style>
</head>
<body>
  <header>
    <h1>Trailing Stop Bot — Status</h1>
  </header>
  <main>
    <section class="card">
      <div class="grid">
        <div class="metric">
          <h3>Trading Pair</h3>
          <div id="pair" class="value">—</div>
        </div>
        <div class="metric">
          <h3>Latest Price</h3>
          <div id="price" class="value">—</div>
        </div>
        <div class="metric">
          <h3>Position</h3>
          <div id="position" class="value">—</div>
        </div>
        <div class="metric">
          <h3>Highest Price</h3>
          <div id="highest" class="value">—</div>
        </div>
        <div class="metric">
          <h3>Trailing Stop</h3>
          <div id="stop" class="value">—</div>
        </div>
        <div class="metric">
          <h3>Activation Price</h3>
          <div id="activationPrice" class="value">—</div>
        </div>
        <div class="metric">
          <h3>Config</h3>
          <div id="configTrail" class="value" style="font-size:14px">—</div>
        </div>
        <div class="metric">
          <h3>Status</h3>
          <div id="active" class="value">—</div>
        </div>
        <div class="metric">
          <h3>Desired Action</h3>
          <div id="desired" class="value">—</div>
        </div>
      </div>
    </section>
    <section class="card">
      <h3 style="margin-top:0">Portfolio</h3>
      <div id="totals" style="margin-bottom:10px; color:#94a3b8"></div>
      <div class="grid">
        <div class="metric" style="grid-column: 1 / -1">
          <h3>Cash and Digital Cash (Fiat)</h3>
          <div id="fiat" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; white-space: pre; line-height: 1.8"></div>
        </div>
        <div class="metric" style="grid-column: 1 / -1">
          <h3>Crypto</h3>
          <div id="crypto"></div>
        </div>
      </div>
    </section>
    <section class="card">
      <h3 style="margin-top:0">Live Feed</h3>
      <pre id="log" style="max-height:220px; overflow:auto; margin:0"></pre>
    </section>
  </main>
  <footer>
    Served from /public. Live updates via SSE at <code>/status/stream</code>.
  </footer>
  <script>
    const $ = (id) => document.getElementById(id);
    const fmt = (n) => (typeof n === 'number' && isFinite(n) ? n.toLocaleString(undefined, { maximumFractionDigits: 2 }) : '—');
    let lastPrice = undefined;

    function render(s) {
      $('pair').textContent = s.tradingPair || '—';
      const priceEl = $('price');
      const newPrice = s.latestPrice;
      priceEl.textContent = fmt(newPrice);
      if (lastPrice === undefined) {
        lastPrice = newPrice;
      }
      if (typeof newPrice === 'number' && isFinite(newPrice) && typeof lastPrice === 'number' && isFinite(lastPrice)) {
        if (newPrice > lastPrice) {
            priceEl.classList.remove('red');
            priceEl.classList.add('green');
            lastPrice = newPrice;
        }
        else if (newPrice < lastPrice) {
            priceEl.classList.remove('green');
            priceEl.classList.add('red');
            lastPrice = newPrice;
        }
      }
      $('position').textContent = s.currentPosition || '—';
      $('highest').textContent = fmt(s.highestPrice);
      $('stop').textContent = fmt(s.trailingStopPrice);
      $('active').textContent = s.isActive ? 'Active' : 'Idle';
      $('active').className = 'value ' + (s.isActive ? 'green' : 'red');
      $('desired').textContent = s.desiredAction || '—';
      $('activationPrice').textContent = fmt(s.activationPrice);
      $('configTrail').textContent =
        (typeof s.trailingPercent === 'number' && typeof s.activationThresholdPercent === 'number')
          ? `${s.trailingPercent}% trail • ${s.activationThresholdPercent}% activate`
          : '—';

      // Render portfolio (fiat and crypto)
      const pf = s.portfolio || { fiat: [], crypto: [], totals: { fiatGbp: 0, cryptoGbp: 0, grandGbp: 0 } };
      $('totals').textContent = `Total: £${fmt(pf.totals?.grandGbp)}  (Fiat £${fmt(pf.totals?.fiatGbp)} • Crypto £${fmt(pf.totals?.cryptoGbp)})`;

      const fiatLines = (pf.fiat || []).map(r => {
        const amt = Number(r.amount).toLocaleString(undefined, { maximumFractionDigits: 2 });
        const gbp = Number(r.gbpValue).toLocaleString(undefined, { maximumFractionDigits: 2 });
        return `${r.currency.padEnd(6)} ${amt.padStart(10)}   →  £${gbp}`;
      });
      $('fiat').textContent = fiatLines.length ? fiatLines.join('\n') : '— none —';

      const cryptoRows = (pf.crypto || []).map(r => {
        const qty = Number(r.amount).toLocaleString(undefined, { maximumFractionDigits: 8 });
        const px = (r.gbpPrice == null) ? '—' : `£${Number(r.gbpPrice).toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
        const val = (r.gbpValue == null) ? '—' : `£${Number(r.gbpValue).toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
        const entry = (r.avgEntryGbp == null) ? '—' : `£${Number(r.avgEntryGbp).toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
        const retGbp = (r.pnlGbp == null) ? '—' : `£${Number(r.pnlGbp).toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
        const retPct = (r.pnlPct == null) ? '—' : `${Number(r.pnlPct).toFixed(2)}%`;
        return `<tr>
          <td>${r.asset}</td>
          <td class="num">${qty}</td>
          <td class="num">${px}</td>
          <td class="num">${val}</td>
          <td class="num">${entry}</td>
          <td class="num">${retGbp}</td>
          <td class="num">${retPct}</td>
        </tr>`;
      }).join('');
      $('crypto').innerHTML = (pf.crypto && pf.crypto.length)
        ? `<table class="crypto" role="table" aria-label="Crypto holdings">
            <thead>
              <tr>
                <th>Asset</th>
                <th class="num">Qty</th>
                <th class="num">Price</th>
                <th class="num">Value</th>
                <th class="num">Avg Entry</th>
                <th class="num">Return £</th>
                <th class="num">Return %</th>
              </tr>
            </thead>
            <tbody>${cryptoRows}</tbody>
           </table>`
        : '— none —';
    }

    function log(msg) {
      const el = $('log');
      const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
      el.textContent = `${line}\n${el.textContent}`.slice(0, 4000);
    }

    const es = new EventSource('/status/stream');
    es.onmessage = (ev) => {
      try {
        const s = JSON.parse(ev.data);
        render(s);
      } catch (e) {
        log('Bad event payload');
      }
    };
    es.onerror = () => {
      log('Stream disconnected, retrying…');
    };
  </script>
</body>
</html>
